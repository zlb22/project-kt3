# Topic-Three-Web 项目使用文档

## 项目概述

Topic-Three-Web 是一个基于 Vue 3 的创造性问题解决测试系统。该系统主要用于评估用户的创造性思维能力，通过图形化界面让用户设计出创新的解决方案。

**核心任务：** 用户需要利用提供的图形元素设计一个独特的、切实可行的装置将货物运送过河。

## 技术栈

- **前端框架：** Vue 3 + TypeScript
- **UI 组件库：** Element Plus
- **状态管理：** Pinia
- **路由：** Vue Router 4
- **画布绘制：** Fabric.js
- **构建工具：** Vite
- **CSS 预处理：** Sass
- **文件上传：** 阿里云 OSS
- **其他工具：** Axios、JSZip、MD5

## 项目结构

```
topic-three-web/
├── src/
│   ├── api/                    # API 接口
│   │   ├── index.ts           # 主要 API 接口
│   │   └── login.ts           # 登录相关接口
│   ├── assets/                # 静态资源
│   │   ├── images/            # 图片资源（包含各种图形元素图标）
│   │   └── main.css           # 主要样式文件
│   ├── components/            # 公共组件
│   │   ├── Countdown.vue      # 倒计时组件
│   │   └── NaviBar.vue        # 导航栏组件
│   ├── core/                  # 核心图形元素类
│   │   ├── Circle.ts          # 圆形
│   │   ├── Cone.ts            # 圆锥
│   │   ├── Cube.ts            # 正方体
│   │   ├── Cylinder.ts        # 圆柱
│   │   ├── Hook.ts            # 弯钩
│   │   ├── Line.ts            # 直线
│   │   ├── Pentagon.ts        # 五边形
│   │   ├── Rect.ts            # 矩形
│   │   ├── Semicircle.ts      # 半圆
│   │   ├── Triangle.ts        # 三角形
│   │   ├── TriangularPyramid.ts # 三棱锥
│   │   ├── Curve.ts           # 曲线
│   │   ├── propsMap.ts        # 图形元素映射
│   │   └── ControlsConfig.ts  # Fabric.js 控制配置
│   ├── stores/                # Pinia 状态管理
│   │   ├── files.ts           # 文件管理状态
│   │   ├── operationHistory.ts # 操作历史状态
│   │   └── workspace.ts       # 工作空间状态
│   ├── utils/                 # 工具函数
│   │   ├── axios.ts           # HTTP 请求配置
│   │   ├── update.ts          # OSS 上传工具
│   │   └── url.ts             # URL 工具
│   ├── views/                 # 页面组件
│   │   ├── components/        # 页面级组件
│   │   │   ├── ConfirmCommit.vue     # 确认提交弹窗
│   │   │   ├── ForwardAndBackwardControl.vue # 撤销/重做控制
│   │   │   ├── Music.vue             # 音乐组件
│   │   │   ├── MyRecord.vue          # 录音组件
│   │   │   ├── PropsBar.vue          # 图形元素工具栏
│   │   │   ├── StopAnswerModal.vue   # 停止答题弹窗
│   │   │   └── ToolBar.vue           # 编辑工具栏
│   │   ├── FirstStep.vue      # 第一步：欢迎页面
│   │   ├── SecondStep.vue     # 第二步：方案绘制
│   │   ├── ThirdStep.vue      # 第三步：上传完成
│   │   └── HomeView.vue       # 主页面
│   ├── App.vue                # 根组件
│   └── main.ts                # 应用入口
├── public/                    # 公共资源
├── package.json               # 项目配置
├── vite.config.ts            # Vite 配置
└── tsconfig.json             # TypeScript 配置
```

## 系统功能说明

### 三步流程设计

#### 第一步：欢迎页面 (FirstStep.vue)
- **功能：** 项目介绍和用户信息收集
- **主要组件：**
  - 欢迎界面：显示项目logo和任务说明
  - 视频播放：展示任务演示视频
  - 信息录入：收集用户学校、年级、姓名等信息
- **时间限制：** 无限制
- **操作：** 点击"开始"按钮进入下一步

#### 第二步：方案绘制 (SecondStep.vue)
- **功能：** 核心创作环节，用户使用图形元素设计解决方案
- **主要组件：**
  - **画布区域：** 基于 Fabric.js 的交互式画布
  - **图形工具栏：** 12种图形元素可供选择
  - **编辑工具栏：** 翻转、层级调整等编辑功能
  - **操作控制：** 撤销/重做功能
  - **录音功能：** 用户可录制语音说明
- **时间限制：** 8分钟绘制 + 1分钟录音
- **图形元素包括：**
  - 基础形状：矩形、圆形、三角形、五边形、半圆
  - 立体图形：正方体、圆柱、圆锥、三棱锥
  - 特殊元素：直线、曲线、弯钩

#### 第三步：上传完成 (ThirdStep.vue)
- **功能：** 数据上传和任务完成确认
- **主要功能：**
  - 显示上传进度
  - 上传画布截图到 OSS
  - 上传录音文件到 OSS
  - 显示完成状态

### 状态管理 (Pinia Stores)

#### 工作空间状态 (workspace.ts)
- **step：** 当前步骤 (1-3)
- **remainTime：** 剩余时间（秒）
- **propsList：** 可用图形元素列表
- **addedProps：** 已添加的图形元素计数
- **showToolbar：** 是否显示编辑工具栏
- **showRecord：** 是否显示录音界面

#### 操作历史 (operationHistory.ts)
- **操作类型：** 新增、移动、删除、缩放、旋转、翻转等
- **历史记录：** 完整的操作日志，支持撤销/重做
- **停留时间：** 记录用户在每个操作上的停留时间

#### 文件管理 (files.ts)
- **audioFile：** 录音文件
- **imgFile：** 画布截图文件
- **authToken：** 认证令牌
- **commitStatus：** 提交状态

## OSS上传流程详解

### 上传流程概述

OSS（阿里云对象存储）上传流程主要在 `src/utils/update.ts` 文件中实现，整个流程分为以下几个步骤：

### 1. 获取OSS认证
**位置：** `src/utils/update.ts` 第63行
```typescript
const { data } = await getOssAuth()
```
- **接口：** ``
- **返回数据：** AccessKeyId、AccessKeySecret、SecurityToken、Bucket、Domain等认证信息

### 2. 初始化OSS客户端
**位置：** `src/utils/update.ts` 第67-73行
```typescript
const client = new OSS({
  region: EnumRegion.BeiJing,           // 北京区域
  accessKeyId: data.data.AccessKeyId,
  accessKeySecret: data.data.AccessKeySecret,
  stsToken: data.data.SecurityToken,
  bucket: data.data.Bucket
})
```

### 3. 文件上传策略
**位置：** `src/utils/update.ts` 第74-83行

#### 文件命名规则：
- **图片文件：** `img${uid}${timestamp}`
- **音频文件：** `audio${uid}${timestamp}`

#### 上传文件类型：
- **图片：** 画布截图 (PNG格式)
- **音频：** 用户录音 (音频格式)

### 4. 分片上传实现
**位置：** `src/utils/update.ts` 第90-110行

#### 上传配置：
```typescript
const config = {
  parallel: 4,              // 并行上传数量
  partSize: 1024 * 1024,   // 分片大小 1MB
}
```

#### 进度监控：
- **图片上传进度：** 0-49%
- **音频上传进度：** 0-49%  
- **总进度：** 图片进度 + 音频进度 (最大98%)
- **完成状态：** 后端确认后更新为100%

### 5. 上传触发位置

#### 主要触发点：
1. **绘制完成：** 用户点击"完成绘制"按钮
   - **位置：** `src/components/NaviBar.vue` 
   - **函数：** `finish()` 方法

2. **录音结束：** 用户完成录音说明
   - **位置：** `src/views/components/MyRecord.vue`
   - **函数：** 录音组件的提交方法

#### 文件生成：
1. **画布截图：** 通过 Fabric.js 的 `toDataURL()` 方法生成
2. **音频文件：** 通过浏览器 MediaRecorder API 录制

### 6. 上传状态管理

#### 进度状态：
- **存储位置：** `src/utils/update.ts` config对象
- **显示位置：** `src/views/ThirdStep.vue`
- **状态字段：**
  - `authProgress`：总体上传进度
  - `imgProgress`：图片上传进度  
  - `audioProgress`：音频上传进度

#### 错误处理：
- 网络异常捕获
- 认证失败处理
- 上传失败重试机制

### 7. 文件访问路径

#### URL构成：
```
最终访问地址 = ${HttpsDomain}/${fileKey}
```
- **HttpsDomain：** OSS返回的HTTPS域名
- **fileKey：** 上传时的文件键名

#### 示例：
```
图片URL: https://xxx.oss-cn-beijing.aliyuncs.com/img123456789012345
音频URL: https://xxx.oss-cn-beijing.aliyuncs.com/audio123456789012345
```

## API接口说明

### 主要接口 (src/api/index.ts)

1. **获取配置信息**
   - **接口：** `POST /web/keti3/config/list`
   - **功能：** 获取学校、年级等配置信息

2. **保存数据**
   - **接口：** `POST /web/keti3/log/save`
   - **功能：** 保存用户操作日志和最终作品

3. **获取OSS认证**
   - **接口：** `POST /web/keti3/oss/auth`
   - **功能：** 获取阿里云OSS上传凭证

### 认证机制 (src/utils/axios.ts)

- **Token认证：** 通过URL参数或localStorage获取AuthToken
- **签名验证：** 使用MD5签名验证请求合法性
- **请求头设置：**
  - `Authorization`：认证token
  - `X-Auth-AppId`：应用ID
  - `X-Auth-TimeStamp`：时间戳
  - `X-Sign`：MD5签名

## 开发环境配置

### 安装依赖
```bash
npm install
# 或
yarn install
```

### 开发模式
```bash
npm run dev
# 访问：http://localhost:5173
```

### 构建生产版本
```bash
npm run build        # 正式环境
npm run build:test   # 测试环境
```

### 代码检查
```bash
npm run lint         # ESLint检查
npm run format       # Prettier格式化
```

## 环境变量配置

项目需要配置以下环境变量：
- `VITE_APP_ID`：应用ID
- `VITE_SKEY`：签名密钥
- `VITE_LOGIN_URL`：登录跳转地址

## 注意事项

1. **浏览器兼容性：** 需要支持Canvas和MediaRecorder API的现代浏览器
2. **网络要求：** 需要稳定的网络连接以确保文件上传成功
3. **存储空间：** 单次会话会产生图片和音频文件，需要足够的OSS存储空间
4. **时间限制：** 严格的时间控制，超时会自动提交
5. **数据安全：** 所有上传文件都有唯一标识，避免数据冲突

## 常见问题

1. **上传失败：** 检查网络连接和OSS认证配置
2. **录音无效：** 确认浏览器已授权麦克风权限
3. **画布异常：** 确认Fabric.js版本兼容性
4. **时间异常：** 检查系统时间和服务器时间同步

此文档涵盖了项目的主要功能和OSS上传流程，如需更详细的技术实现，请参考相应的源码文件。
