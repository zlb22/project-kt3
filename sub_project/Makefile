# Keti3 Project Makefile
# ä¸€é”®å¯åŠ¨å’Œç®¡ç†å‰åç«¯æœåŠ¡

.PHONY: help start stop restart backend frontend logs clean status

# é»˜è®¤ç›®æ ‡
help:
	@echo "Keti3 Project Management"
	@echo "========================"
	@echo "make start     - å¯åŠ¨åç«¯å’Œå‰ç«¯æœåŠ¡"
	@echo "make stop      - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "make restart   - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "make backend   - ä»…å¯åŠ¨åç«¯æœåŠ¡"
	@echo "make frontend  - ä»…å¯åŠ¨å‰ç«¯æœåŠ¡"
	@echo "make logs      - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "make status    - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "make clean     - æ¸…ç†æ—¥å¿—æ–‡ä»¶"

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start:
	@echo "ğŸš€ å¯åŠ¨ Keti3 é¡¹ç›®æœåŠ¡..."
	@make backend &
	@sleep 3
	@make frontend &
	@echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ!"
	@echo "ğŸ“± å‰ç«¯: http://localhost:5173/topic-three"
	@echo "ğŸ”§ åç«¯: http://localhost:8096"

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@pkill -f "uvicorn app.main:app" || true
	@pkill -f "vite.*sub_frontend" || true
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# é‡å¯æœåŠ¡
restart: stop
	@sleep 2
	@make start

# å¯åŠ¨åç«¯æœåŠ¡
backend:
	@echo "ğŸ”§ å¯åŠ¨åç«¯æœåŠ¡ (ç«¯å£ 8096)..."
	@cd sub_backend/backend-py && \
	nohup uvicorn app.main:app --host 0.0.0.0 --port 8096 --reload > ../../logs/backend.log 2>&1 &
	@echo "âœ… åç«¯æœåŠ¡å·²å¯åŠ¨"

# å¯åŠ¨å‰ç«¯æœåŠ¡
frontend:
	@echo "ğŸ“± å¯åŠ¨å‰ç«¯æœåŠ¡ (ç«¯å£ 5173)..."
	@cd sub_frontend && \
	nohup npm run dev > ../logs/frontend.log 2>&1 &
	@echo "âœ… å‰ç«¯æœåŠ¡å·²å¯åŠ¨"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
	@echo "=== åç«¯æ—¥å¿— ==="
	@tail -n 20 logs/backend.log 2>/dev/null || echo "åç«¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
	@echo ""
	@echo "=== å‰ç«¯æ—¥å¿— ==="
	@tail -n 20 logs/frontend.log 2>/dev/null || echo "å‰ç«¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥..."
	@echo "=== åç«¯æœåŠ¡ (8096ç«¯å£) ==="
	@if pgrep -f "uvicorn app.main:app" > /dev/null; then \
		echo "âœ… åç«¯æœåŠ¡è¿è¡Œä¸­"; \
		curl -s http://localhost:8096/health > /dev/null && echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡" || echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"; \
	else \
		echo "âŒ åç«¯æœåŠ¡æœªè¿è¡Œ"; \
	fi
	@echo ""
	@echo "=== å‰ç«¯æœåŠ¡ (5173ç«¯å£) ==="
	@if pgrep -f "vite.*sub_frontend" > /dev/null; then \
		echo "âœ… å‰ç«¯æœåŠ¡è¿è¡Œä¸­"; \
		curl -s http://localhost:5173 > /dev/null && echo "âœ… å‰ç«¯æœåŠ¡å¯è®¿é—®" || echo "âŒ å‰ç«¯æœåŠ¡ä¸å¯è®¿é—®"; \
	else \
		echo "âŒ å‰ç«¯æœåŠ¡æœªè¿è¡Œ"; \
	fi
	@echo ""
	@echo "=== Docker ä¾èµ–æœåŠ¡ ==="
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(mysql|minio|mongodb)" || echo "âŒ æœªå‘ç° Docker ä¾èµ–æœåŠ¡"

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
	@rm -f logs/*.log
	@echo "âœ… æ—¥å¿—æ–‡ä»¶å·²æ¸…ç†"

# åˆå§‹åŒ–é¡¹ç›®ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
init:
	@echo "ğŸ”§ åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ..."
	@mkdir -p logs
	@echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
	@cd sub_frontend && npm install
	@echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
	@cd sub_backend/backend-py && pip install -r requirements.txt
	@echo "âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"

# å¼€å‘æ¨¡å¼ï¼ˆå®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼‰
dev:
	@echo "ğŸ”§ å¼€å‘æ¨¡å¼å¯åŠ¨..."
	@mkdir -p logs
	@make backend
	@sleep 3
	@make frontend
	@echo "ğŸ“‹ å®æ—¶æŸ¥çœ‹æ—¥å¿— (Ctrl+C é€€å‡º)..."
	@tail -f logs/backend.log logs/frontend.log

# æµ‹è¯•æ¥å£
test:
	@echo "ğŸ§ª æµ‹è¯•åç«¯æ¥å£..."
	@echo "æµ‹è¯•å¥åº·æ£€æŸ¥..."
	@curl -s http://localhost:8096/health || echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
	@echo ""
	@echo "æµ‹è¯•é…ç½®æ¥å£..."
	@TS=$$(date +%s); \
	SKEY='YJNGFHGASBDG#Y8d'; \
	SIGN=$$(printf "%s" "$${SKEY}$${TS}" | md5sum | awk '{print $$1}'); \
	curl -s -X POST 'http://localhost:8096/web/keti3/config/list' \
		-H "X-Auth-AppId: keti-3" \
		-H "X-Auth-TimeStamp: $$TS" \
		-H "X-Sign: $$SIGN" \
		-H 'Content-Type: application/json' \
		-d '{}' | jq . || echo "âŒ é…ç½®æ¥å£æµ‹è¯•å¤±è´¥"
